#!/usr/bin/env perl
use FindBin qw($Bin);
use lib "$Bin/../lib";

use Getopt::Long;
use Term::Readline;

use AutoHarp::Environment;

use Term::ReadLine;
my $term = Term::ReadLine->new('Simple Perl calc');
print "=====================\n";
print "= AutoHarp Workshop =\n";
print "=     Fuck You      =\n";
print "=====================\n";
print "\n\n";
my $prompt = "==> ";
my $OUT = $term->OUT || \*STDOUT;
my $env = AutoHarp::Environment->new();
while ( defined (my $line = $term->readline($prompt)) ) {
  my @tokens = split(/\s+/, $line);
  my $cmd = lc(shift(@tokens));
  if (!$cmd) {
    next;
  } elsif ($cmd eq 'q' || $cmd eq 'quit') {
    last;
  }

  my $func = "cmd_$cmd";

  if (!$env->can($func)) {
    print "$cmd is an unrecognized command\n";
    next;
  }
  eval {
    $env->$func(@tokens);
  };
  if ($@) {
    print "That didn't work, did it?\n";
    print $@;
    print "\n\n";
  } else {
    while ($env->hasMsg()) {
      print $env->dequeueMsg();
      print "\n";
    }
    $term->addhistory($_) if /\S/;
  }
}
$env->cleanUp();

exit(0);
