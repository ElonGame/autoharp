#!/usr/bin/env perl
use FindBin qw($Bin);
use lib "$Bin/../lib";

use strict;
use AutoHarp::Constants;
use AutoHarp::Model::Loop;
use AutoHarp::Model::Genre;
use AutoHarp::Model::LoopGenre;
use AutoHarp::Model::LoopFeedback;
use AutoHarp::Model::LoopAttribute;

print "Really??? ";
chomp(my $resp = <STDIN>);
if ($resp !~ /^y/i) {
  print "Okay. NOT DOING THIS.\n";
  exit(0);
}
print "GOING NUCLEAR.\n";
my $g = AutoHarp::Model::Genre->loadByName($ATTR_MACHINE_GENRE);
foreach my $lg (@{AutoHarp::Model::LoopGenre->all({genre_id => $g->id})}) {
  my $l = AutoHarp::Model::Loop->load($lg->loop_id);
  if (scalar @{$l->genres()} == 1) {
    printf "Nuking $ATTR_MACHINE_GENRE-only loop %d\n",$loop->id;
    $l->delete();
  } else {
    printf "Keeping loop %d because it belongs to other genres\n",$loop->id;
  }
}

print "Nuclearness went-ed.\n";

exit(0);
