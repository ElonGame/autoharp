#!/usr/bin/env perl
use FindBin qw($Bin);
use lib "$Bin/../lib";

use strict;
use AutoHarp::Model::Loop;
use AutoHarp::Events::DrumTrack;
use AutoHarp::Constants;
use AutoHarp::Config;
use MIDI;

my $resultFile = $ARGV[0];
if ($resultFile && -f $resultFile) {
  open(FILE, $resultFile) or die "Can't open $resultFile: $!\n";
  my $events = AutoHarp::Events::DrumTrack->new();
  while(<FILE>) {
    if ($_ =~ /note/) {
      chomp();
      my $e = AutoHarp::Event::Note->fromTextLine($_);
      $events->add($e);
    } elsif (/marker/ && $events->duration() > 0) {
      $events->repeat(); 
      $events->repeat();
      my $opus = MIDI::Opus->new({tracks => [$events->track()],
				  ticks => $TICKS_PER_BEAT,
				  format => 1});
      AutoHarp::Config::PlayOpus($opus);
      $events = AutoHarp::Events::DrumTrack->new();
      print "Enter to continue";
      <STDIN>
    }
  }

  exit(0);
}

my $outputDir = "$ENV{HOME}/workspace/char-rnn/data/autoharp_two";
if (!-d $outputDir) {
  mkdir($outputDir);
}

open(FILE, ">$outputDir/input.txt");
foreach my $loop (@{AutoHarp::Model::Loop->all({type => $DRUM_LOOP})}) {
  my $buckets = $loop->getBuckets();
  my $genres  = $loop->genres();
  my $elts    = $loop->getSongElements();
  my $events  = $loop->events();
  foreach my $g (@$genres) {
    printf FILE "%s: %s\n",$ATTR_GENRE,$g->name;
  }
  foreach my $b (@$buckets) {
    printf FILE "%s: %s\n",$ATTR_BUCKET,$b;
  }
  foreach my $e (@$elts) {
    printf FILE "%s: %s\n",$SONG_ELEMENT,$e;
  }
  printf FILE "%s: %s\n",$ATTR_METER,$loop->meter;
  foreach my $e (@$events) {
    printf FILE "%s\n",$e->toTextLine();
  }
}
close(FILE);

exit(0);
